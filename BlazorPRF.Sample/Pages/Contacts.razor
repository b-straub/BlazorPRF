@page "/contacts"
@attribute [Authorize]
@inherits ContactsModelComponent
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Contacts - BlazorPRF</PageTitle>

<MudGrid Class="mb-4">
    <MudItem xs="12" sm="8">
        <MudText Typo="Typo.h4" GutterBottom="true">Trusted Contacts</MudText>
        <MudText Typo="Typo.body1">
            Manage your verified contacts. User data is encrypted with your PRF-derived key.
        </MudText>
    </MudItem>
</MudGrid>

<ContactsPanel OnCreateInviteRequested="OpenCreateInviteDialogAsync"
               OnAcceptInviteRequested="OpenAcceptInviteDialogAsync"
               OnVerifyResponseRequested="OpenVerifyDialogAsync" />

@code {
    private async Task OpenVerifyDialogAsync()
    {
        if (!await Model.PrfModel.EnsureKeysAsync())
        {
            Snackbar.Add("Authentication required to verify responses.", Severity.Warning);
            return;
        }

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<VerifyResponseDialog>("Verify Response & Add Contact", options);
        _ = await dialog.Result;
    }

    private async Task OpenCreateInviteDialogAsync()
    {
        if (!await Model.PrfModel.EnsureKeysAsync())
        {
            Snackbar.Add("Authentication required to create invitations.", Severity.Warning);
            return;
        }

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<CreateInviteDialog>("Create New Invitation", options);
        _ = await dialog.Result;
    }

    private async Task OpenAcceptInviteDialogAsync()
    {
        if (!await Model.PrfModel.EnsureKeysAsync())
        {
            Snackbar.Add("Authentication required to accept invitations.", Severity.Warning);
            return;
        }

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<AcceptInviteDialog>("Accept an Invitation", options);
        _ = await dialog.Result;
    }
}
