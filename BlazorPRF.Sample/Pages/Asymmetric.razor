@page "/asymmetric"
@attribute [Authorize]
@using BlazorPRF.Shared.Crypto.Formatting
@inject ITrustedContactService ContactService
@inject PrfModel PrfModel
@inject NavigationManager NavigationManager

<PageTitle>Asymmetric Encryption - BlazorPRF</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">Asymmetric Encryption (ECIES)</MudText>
<MudText Typo="Typo.body1" Class="mb-6">
    Share your public key with others. They can encrypt messages to you that only you can decrypt.
</MudText>

<MudGrid>
    <MudItem xs="12" md="6">
        @if (_contactsLoaded && _contacts.Count > 0)
        {
            <MudCard Class="mb-4">
                <MudCardContent>
                    <MudText Typo="Typo.subtitle2" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Contacts" Size="Size.Small" Class="mr-1" />
                        Select from Trusted Contacts
                    </MudText>
                    <MudSelect T="Guid?"
                               Value="_selectedContactId"
                               ValueChanged="OnContactSelected"
                               Label="Recipient"
                               Variant="Variant.Outlined"
                               Placeholder="Choose a contact..."
                               Clearable="true"
                               Dense="true">
                        @foreach (var (contact, userData) in _contacts)
                        {
                            <MudSelectItem Value="@((Guid?)contact.Id)">
                                @userData.Username (@userData.Email)
                            </MudSelectItem>
                        }
                    </MudSelect>
                </MudCardContent>
            </MudCard>
        }

        <AsymmetricEncryptPanel InitialPublicKey="@_selectedPublicKey" />
    </MudItem>

    <MudItem xs="12">
        <AsymmetricDecryptPanel />
    </MudItem>
</MudGrid>

@code {
    private List<(TrustedContact Contact, ContactUserData UserData)> _contacts = [];
    private bool _contactsLoaded;
    private Guid? _selectedContactId;
    private string? _selectedPublicKey;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadContactsAsync();

            // Check for public key in query string (from Contacts page)
            var uri = new Uri(NavigationManager.Uri);
            var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);
            var keyParam = queryParams["key"];
            if (!string.IsNullOrWhiteSpace(keyParam))
            {
                // Try to match with a contact's public key
                var matchedContact = _contacts.FirstOrDefault(c => c.Contact.X25519PublicKey == keyParam);
                if (matchedContact.Contact is not null)
                {
                    // Found a matching contact - select it in the dropdown
                    _selectedContactId = matchedContact.Contact.Id;

                    // Create armored public key with metadata
                    var metadata = new PublicKeyMetadata
                    {
                        Name = matchedContact.UserData.Username,
                        Email = matchedContact.UserData.Email,
                        Comment = matchedContact.UserData.Comment
                    };
                    _selectedPublicKey = PrfArmor.ArmorPublicKey(keyParam, metadata);
                }
                else
                {
                    // No matching contact - use raw key
                    _selectedPublicKey = keyParam;
                }
            }

            StateHasChanged();
        }
    }

    private async Task LoadContactsAsync()
    {
        // Ensure keys for decrypting contact data
        if (!await PrfModel.EnsureKeysAsync())
        {
            _contactsLoaded = true;
            return;
        }

        var result = await ContactService.GetAllAsync();
        if (result is { Success: true, Value: not null })
        {
            _contacts = result.Value;
        }

        _contactsLoaded = true;
    }

    private void OnContactSelected(Guid? contactId)
    {
        _selectedContactId = contactId;

        if (contactId is null)
        {
            _selectedPublicKey = null;
            return;
        }

        var selected = _contacts.FirstOrDefault(c => c.Contact.Id == contactId.Value);
        if (selected.Contact is not null && selected.UserData is not null)
        {
            // Create armored public key with metadata
            var metadata = new PublicKeyMetadata
            {
                Name = selected.UserData.Username,
                Email = selected.UserData.Email,
                Comment = selected.UserData.Comment
            };

            _selectedPublicKey = PrfArmor.ArmorPublicKey(selected.Contact.X25519PublicKey, metadata);
        }
    }
}
