@page "/"
@using BlazorPRF.Shared.Crypto.Formatting
@inherits PrfModelComponent

<PageTitle>BlazorPRF Demo</PageTitle>

<AuthorizeView>
    <NotAuthorized>
        <MudContainer MaxWidth="MaxWidth.Small" Class="d-flex flex-column align-center justify-center" Style="min-height: 70vh;">
            <MudIcon Icon="@Icons.Material.Filled.Security" Color="Color.Primary" Style="font-size: 6rem;" Class="mb-4" />

            <MudText Typo="Typo.h3" Align="Align.Center" GutterBottom="true">
                PRF-Based Encryption
            </MudText>

            <MudText Typo="Typo.body1" Align="Align.Center" Class="mb-6 mud-text-secondary">
                Secure encryption using your passkey. Your biometric generates cryptographic keys
                that work across all your synced devices.
            </MudText>

            @if (Model.IsPrfSupported == false)
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">
                    PRF extension is not supported on this device or browser.
                </MudAlert>
            }
            else if (Model.ErrorMessage is not null)
            {
                <MudAlert Severity="Severity.Error" Class="mb-4" Variant="Variant.Outlined">
                    @Model.ErrorMessage
                </MudAlert>
            }

            @if (Model.IsPrfSupported != false)
            {
                @* Decision based on stored credential hint - the only reliable way to know if user registered before *@
                @if (!string.IsNullOrWhiteSpace(Model.CredentialId))
                {
                    @* Returning user with stored credential *@
                    <MudStack Row="true" Spacing="2" Class="mb-4">
                        <MudButtonAsyncRx Command="@Model.DeriveKeys"
                                          Variant="Variant.Filled"
                                          Color="Color.Primary"
                                          Size="Size.Large"
                                          StartIcon="@Icons.Material.Filled.Fingerprint">
                            Authenticate
                        </MudButtonAsyncRx>
                    </MudStack>
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">
                        Using saved credential
                    </MudText>
                }
                else
                {
                    @* New user or cleared storage - prompt to register *@
                    <MudAlert Severity="Severity.Info" Class="mb-4" Variant="Variant.Outlined">
                        No saved passkey found. Register a new passkey to get started.
                    </MudAlert>
                    <MudButton Href="setup"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Large"
                               StartIcon="@Icons.Material.Filled.PersonAdd">
                        Register Passkey
                    </MudButton>
                }
            }

            <MudDivider Class="my-6" Style="width: 100%;" />

            <MudStack Row="true" Spacing="4" Justify="Justify.Center" AlignItems="AlignItems.Center">
                @if (!string.IsNullOrWhiteSpace(Model.CredentialId))
                {
                    @* Returning user - offer to register additional passkey or use different one *@
                    <div>
                        <MudText Typo="Typo.h6" Align="Align.Center" GutterBottom="true">
                            Different passkey?
                        </MudText>
                        <MudButton Href="setup"
                                   Variant="Variant.Outlined"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.PersonAdd">
                            Setup
                        </MudButton>
                    </div>

                    <MudDivider Vertical="true" FlexItem="true" />
                }

                <div>
                    <MudText Typo="Typo.h6" Align="Align.Center" GutterBottom="true">
                        Have a public key?
                    </MudText>
                    <MudButton Href="encrypt"
                               Variant="Variant.Outlined"
                               Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.Lock">
                        Encrypt a Message
                    </MudButton>
                </div>
            </MudStack>
        </MudContainer>
    </NotAuthorized>

    <Authorized>
        <MudText Typo="Typo.h3" GutterBottom="true">Welcome back!</MudText>

        @if (Model.RequiresOnDemandAuth)
        {
            <MudText Typo="Typo.body1" Class="mb-4">
                Ready to encrypt. Choose a method below.
            </MudText>
            <MudAlert Severity="Severity.Info" Class="mb-6" Variant="Variant.Outlined" Dense="true">
                <strong>On-demand authentication</strong> â€” You'll be prompted each time you encrypt or decrypt.
            </MudAlert>
        }
        else
        {
            <MudText Typo="Typo.body1" Class="mb-6">
                Your keys are derived and ready. Choose an encryption method below.
            </MudText>
        }

        <MudGrid>
            <MudItem xs="12" md="6">
                <MudCard Class="cursor-pointer" @onclick="@(() => NavigationManager.NavigateTo("symmetric"))">
                    <MudCardHeader>
                        <CardHeaderAvatar>
                            <MudIcon Icon="@Icons.Material.Filled.Lock" Color="Color.Primary" />
                        </CardHeaderAvatar>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Symmetric Encryption</MudText>
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">Encrypt for yourself</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudText Typo="Typo.body2">
                            Encrypt and decrypt data using your PRF-derived symmetric key.
                            Only you can decrypt this data using your passkey.
                        </MudText>
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Href="symmetric" Variant="Variant.Text" Color="Color.Primary" EndIcon="@Icons.Material.Filled.ArrowForward">
                            Open
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudCard Class="cursor-pointer" @onclick="@(() => NavigationManager.NavigateTo("asymmetric"))">
                    <MudCardHeader>
                        <CardHeaderAvatar>
                            <MudIcon Icon="@Icons.Material.Filled.Send" Color="Color.Secondary" />
                        </CardHeaderAvatar>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Asymmetric Encryption</MudText>
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">Share with others</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudText Typo="Typo.body2">
                            Share your public key with others. They can encrypt messages
                            that only you can decrypt.
                        </MudText>
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Href="asymmetric" Variant="Variant.Text" Color="Color.Secondary" EndIcon="@Icons.Material.Filled.ArrowForward">
                            Open
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudCard Class="cursor-pointer" @onclick="@(() => NavigationManager.NavigateTo("signing"))">
                    <MudCardHeader>
                        <CardHeaderAvatar>
                            <MudIcon Icon="@Icons.Material.Filled.VerifiedUser" Color="Color.Tertiary" />
                        </CardHeaderAvatar>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Digital Signatures</MudText>
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">Prove authenticity</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudText Typo="Typo.body2">
                            Sign messages with your Ed25519 key to prove authenticity.
                            Others can verify your signature using your public key.
                        </MudText>
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Href="signing" Variant="Variant.Text" Color="Color.Tertiary" EndIcon="@Icons.Material.Filled.ArrowForward">
                            Open
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudCard Class="cursor-pointer" @onclick="@(() => NavigationManager.NavigateTo("invite"))">
                    <MudCardHeader>
                        <CardHeaderAvatar>
                            <MudIcon Icon="@Icons.Material.Filled.GroupAdd" Color="Color.Info" />
                        </CardHeaderAvatar>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Identity Verification</MudText>
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">Establish trust</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudText Typo="Typo.body2">
                            Verify user identities through signed invite acceptance.
                            Like PGP "full trust" - cryptographically prove who you're talking to.
                        </MudText>
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Href="invite" Variant="Variant.Text" Color="Color.Info" EndIcon="@Icons.Material.Filled.ArrowForward">
                            Open
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>

            <MudItem xs="12">
                <PublicKeyDisplay PublicKey="@Model.PublicKey"
                                  Metadata="@Model.KeyMetadata"
                                  MetadataChanged="@OnMetadataChanged" />
            </MudItem>

            <MudItem xs="12">
                <MudStack Row="true" Justify="Justify.FlexEnd">
                    <MudButtonRx Command="@Model.ClearKeys"
                                 Variant="Variant.Outlined"
                                 Color="Color.Error"
                                 Size="Size.Small"
                                 StartIcon="@Icons.Material.Filled.Logout">
                        Sign Out
                    </MudButtonRx>
                </MudStack>
            </MudItem>
        </MudGrid>
    </Authorized>
</AuthorizeView>

@code {
    [Inject]
    public required NavigationManager NavigationManager { get; init; }

    private async Task OnMetadataChanged(PublicKeyMetadata? metadata)
    {
        await Model.UpdateKeyMetadataAsync(metadata);
    }
}
