@using BlazorPRF.Persistence.Data
@using BlazorPRF.Sample.Services
@using Microsoft.EntityFrameworkCore
@using SqliteWasmBlazor
@inject IPrfDbInitializationService DbInitService
@inject IDbContextFactory<PrfDbContext> DbContextFactory
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

@if (DbInitService.ErrorMessage is not null)
{
    <MudAlert Severity="Severity.Error" Class="mb-4" Variant="Variant.Filled">
        <MudText Typo="Typo.h6" Class="mb-2">Database Error</MudText>
        <MudText Typo="Typo.body1" Style="white-space: pre-line;" Class="mb-3">
            @DbInitService.ErrorMessage
        </MudText>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Warning"
                   OnClick="ResetDatabaseAsync"
                   StartIcon="@Icons.Material.Filled.RestartAlt"
                   Disabled="_isResetting">
            @if (_isResetting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Resetting...</span>
            }
            else
            {
                <span>Reset Database</span>
            }
        </MudButton>
    </MudAlert>
}
else if (DbInitService.WasRecreated)
{
    <MudAlert Severity="Severity.Info" Class="mb-4" Variant="Variant.Outlined" ShowCloseIcon="true" CloseIconClicked="DismissRecreatedNotice">
        <MudText Typo="Typo.body1">
            Database was recreated due to schema changes. Previous data has been cleared.
        </MudText>
    </MudAlert>
}

@code {
    private bool _isResetting;

    private async Task ResetDatabaseAsync()
    {
        _isResetting = true;
        StateHasChanged();

        try
        {
            // Delete the database file from OPFS SAHPool
            await SqliteWasmWorkerBridge.Instance.DeleteDatabaseAsync("BlazorPrf.db");

            // Clear the error message
            DbInitService.ClearError();

            // Recreate database schema
            await using var context = await DbContextFactory.CreateDbContextAsync();
            await context.Database.EnsureCreatedAsync();

            // Use forceLoad for startup errors - app may be in partially initialized state
            Snackbar.Add("Database reset successfully!", Severity.Success);
            NavigationManager.NavigateTo(NavigationManager.BaseUri, forceLoad: true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Database reset failed: {ex.Message}", Severity.Error);
            DbInitService.ErrorMessage += $"\n\nReset failed: {ex.Message}";
            _isResetting = false;
            StateHasChanged();
        }
    }

    private void DismissRecreatedNotice()
    {
        DbInitService.WasRecreated = false;
    }
}
