@using BlazorPRF.Persistence.Data.Models
@using BlazorPRF.Shared.Crypto.Formatting
@using RxBlazorV2.Model
@using TextCopy
@inherits ContactsModelComponent
@inject IClipboard Clipboard
@inject NavigationManager NavigationManager

@if (Model.Loading)
{
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
        <MudProgressCircular Indeterminate="true" Size="Size.Small" />
        <MudText>Loading contacts...</MudText>
    </MudStack>
}
else if (Model.ErrorMessage is not null)
{
    <MudAlert Severity="Severity.Warning" Class="mb-4" Variant="Variant.Outlined">
        @Model.ErrorMessage
        <MudStack Row="true" Class="mt-2">
            @if (Model.IsDecryptionError)
            {
                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => Model.SignOut.Execute())">
                    Sign Out
                </MudButton>
                <MudButton Variant="Variant.Text"
                           Color="Color.Error"
                           OnClick="@(() => Model.ResetDatabase.ExecuteAsync())"
                           Disabled="Model.ResetDatabase.Executing">
                    @if (Model.ResetDatabase.Executing)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>Resetting...</span>
                    }
                    else
                    {
                        <span>Reset Database</span>
                    }
                </MudButton>
            }
            else
            {
                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => Model.LoadContacts.ExecuteAsync())">
                    Retry
                </MudButton>
            }
        </MudStack>
    </MudAlert>
}
else if (Model.Contacts.Count == 0)
{
    <MudAlert Severity="Severity.Info" Class="mb-4" Variant="Variant.Outlined">
        No trusted contacts yet. Create an invitation or accept one to establish trust with others.
    </MudAlert>
}
else
{
    <MudTable Items="@Model.Contacts" Hover="true" Striped="true" Dense="true" Class="mb-4">
        <HeaderContent>
            <MudTh>Name</MudTh>
            <MudTh>Email</MudTh>
            <MudTh>Trust</MudTh>
            <MudTh>Direction</MudTh>
            <MudTh>Verified</MudTh>
            <MudTh Style="width: 120px;">Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Name">@context.UserData.Username</MudTd>
            <MudTd DataLabel="Email">@context.UserData.Email</MudTd>
            <MudTd DataLabel="Trust">
                <MudChip T="string" Size="Size.Small" Color="@GetTrustColor(context.Contact.TrustLevel)">
                    @context.Contact.TrustLevel
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Direction">
                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined"
                         Color="@(context.Contact.Direction == TrustDirection.SENT ? Color.Primary : Color.Secondary)">
                    @(context.Contact.Direction == TrustDirection.SENT ? "I invited" : "They invited")
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Verified">@context.Contact.VerifiedAt.ToLocalTime().ToString("g")</MudTd>
            <MudTd DataLabel="Actions">
                <MudTooltip Text="Copy X25519 public key">
                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                   Size="Size.Small"
                                   OnClick="@(() => CopyPublicKeyAsync(context.Contact, context.UserData))" />
                </MudTooltip>
                <MudTooltip Text="Encrypt message for this contact">
                    <MudIconButton Icon="@Icons.Material.Filled.Send"
                                   Size="Size.Small"
                                   Href="@($"asymmetric?key={Uri.EscapeDataString(context.Contact.X25519PublicKey)}")" />
                </MudTooltip>
                <MudTooltip Text="Delete contact">
                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                   Size="Size.Small"
                                   Color="Color.Error"
                                   OnClick="@(() => Model.DeleteContact.ExecuteAsync(context.Contact.Id))" />
                </MudTooltip>
            </MudTd>
        </RowTemplate>
    </MudTable>
}

<MudDivider Class="my-4" />

<MudStack Row="true" Wrap="Wrap.Wrap" Spacing="2" Class="gap-2">
    <MudButton Variant="Variant.Outlined"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.GroupAdd"
               OnClick="@(() => OnCreateInviteRequested.InvokeAsync())">
        Create Invitation
    </MudButton>
    <MudButton Variant="Variant.Outlined"
               Color="Color.Secondary"
               StartIcon="@Icons.Material.Filled.Mail"
               OnClick="@(() => OnAcceptInviteRequested.InvokeAsync())">
        Accept Invitation
    </MudButton>
    <MudButton Variant="Variant.Outlined"
               Color="Color.Tertiary"
               StartIcon="@Icons.Material.Filled.PersonAdd"
               OnClick="@(() => OnVerifyResponseRequested.InvokeAsync())">
        Add via Response
    </MudButton>
    <MudButton Variant="Variant.Outlined"
               Color="Color.Default"
               StartIcon="@Icons.Material.Filled.Refresh"
               OnClick="@(() => Model.LoadContacts.ExecuteAsync())"
               Disabled="@Model.Loading">
        Refresh
    </MudButton>
</MudStack>

@code {
    /// <summary>
    /// Raised when user clicks "Create Invitation" button.
    /// </summary>
    [Parameter]
    public EventCallback OnCreateInviteRequested { get; set; }

    /// <summary>
    /// Raised when user clicks "Accept Invitation" button.
    /// </summary>
    [Parameter]
    public EventCallback OnAcceptInviteRequested { get; set; }

    /// <summary>
    /// Raised when user clicks "Add via Response" button.
    /// </summary>
    [Parameter]
    public EventCallback OnVerifyResponseRequested { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Model.LoadContacts.ExecuteAsync();
        }
    }

    /// <summary>
    /// Called reactively when NavigateToRequest changes.
    /// </summary>
    protected override void OnNavigateToRequestChanged()
    {
        if (Model.NavigateToRequest is not null)
        {
            var url = Model.NavigateToRequest;
            Model.NavigateToRequest = null;
            NavigationManager.NavigateTo(url);
        }
    }

    private async Task CopyPublicKeyAsync(TrustedContact contact, ContactUserData? userData)
    {
        var metadata = userData is not null
            ? new PublicKeyMetadata
              {
                  Name = userData.Username,
                  Email = userData.Email,
                  Comment = userData.Comment
              }
            : null;

        var armored = PrfArmor.ArmorPublicKey(contact.X25519PublicKey, metadata);
        await Clipboard.SetTextAsync(armored);
        Model.StatusModel.AddSuccess("Public key copied to clipboard");
    }

    private static Color GetTrustColor(TrustLevel level) => level switch
    {
        TrustLevel.FULL => Color.Success,
        TrustLevel.MARGINAL => Color.Warning,
        _ => Color.Default
    };
}
