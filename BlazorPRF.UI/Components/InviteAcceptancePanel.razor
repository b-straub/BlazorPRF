@using BlazorPRF.Persistence.Services
@inherits InviteAcceptanceModelComponent
@inject IUserProfileService UserProfileService
@inject IClipboard Clipboard
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<MudCard>
    <MudCardHeader>
        <CardHeaderAvatar>
            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Secondary" />
        </CardHeaderAvatar>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">Accept an Invite</MudText>
            <MudText Typo="Typo.body2" Class="mud-text-secondary">Sign your acceptance to prove identity</MudText>
        </CardHeaderContent>
    </MudCardHeader>

    <MudCardContent>
        @if (Model.PrfModel is { HasKeys: false, RequiresOnDemandAuth: false })
        {
            <MudAlert Severity="Severity.Warning" Class="mb-4">
                Please authenticate first using the main page.
            </MudAlert>
        }

        @if (Model.SignedResponse is null)
        {
            <MudTextField @bind-Value="Model.SignedInviteInput"
                          Label="Signed Invite"
                          Variant="Variant.Outlined"
                          Lines="5"
                          Class="mb-2"
                          Placeholder="Paste the signed invite you received"
                          Style="font-family: monospace;"
                          Immediate="true"
                          Disabled="@Model.IsProcessing" />

            @if (Model.InviteValid == true && Model.ParsedEmail is not null)
            {
                <MudAlert Severity="Severity.Success" Class="mb-2" Variant="Variant.Outlined" Dense="true">
                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                        <MudIcon Icon="@Icons.Material.Filled.Verified" Size="Size.Small" />
                        <MudText Typo="Typo.body2">Valid invite for: <strong>@Model.ParsedEmail</strong></MudText>
                    </MudStack>
                </MudAlert>
            }
            else if (Model.InviteValid == false)
            {
                <MudAlert Severity="Severity.Error" Class="mb-2" Variant="Variant.Outlined" Dense="true">
                    <MudText Typo="Typo.body2">Invalid invite signature - do not trust this invite!</MudText>
                </MudAlert>
            }

            <MudText Typo="Typo.subtitle2" Class="mb-2">Your Identity (from profile)</MudText>

            <MudTextField Value="Model.Username"
                          Label="Your Name"
                          Variant="Variant.Filled"
                          Class="mb-2"
                          ReadOnly="true" />

            <MudTextField Value="Model.AccepterEmail"
                          Label="Your Email"
                          Variant="Variant.Filled"
                          Class="mb-2"
                          ReadOnly="true" />

            @if (Model.EmailMismatch)
            {
                <MudAlert Severity="Severity.Warning" Class="mb-4" Variant="Variant.Outlined" Dense="true">
                    <MudText Typo="Typo.body2">
                        This invite was created for <strong>@Model.ParsedEmail</strong>, not your email.
                        You can still accept it, but verify this is intended for you.
                    </MudText>
                </MudAlert>
            }
            else
            {
                <div class="mb-4"></div>
            }

            <MudButton Color="Color.Secondary"
                       Variant="Variant.Filled"
                       StartIcon="@Icons.Material.Filled.Create"
                       OnClick="@(() => Model.SignAcceptance.ExecuteAsync())"
                       Disabled="@(!Model.CanSign)">
                @if (Model.IsProcessing)
                {
                    <MudProgressCircular Indeterminate="true" Size="Size.Small" Class="mr-2" />
                    <span>Signing...</span>
                }
                else
                {
                    <span>Sign Acceptance</span>
                }
            </MudButton>

            @if (Model.ErrorMessage is not null)
            {
                <MudAlert Severity="Severity.Error" Class="mt-4" Variant="Variant.Outlined">
                    @Model.ErrorMessage
                </MudAlert>
            }
        }
        else
        {
            <MudAlert Severity="Severity.Success" Class="mb-4" Icon="@Icons.Material.Filled.Check">
                Acceptance signed as @Model.Username
            </MudAlert>

            <MudText Typo="Typo.subtitle2" Class="mb-2">Next Steps:</MudText>
            <MudList T="string" Dense="true">
                <MudListItem Icon="@Icons.Material.Filled.Reply" IconColor="Color.Primary">
                    Copy and send the response below to the inviter
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.VerifiedUser" IconColor="Color.Secondary">
                    They will verify and add you as a trusted contact
                </MudListItem>
            </MudList>

            <MudPaper Class="pa-3 mt-4" Elevation="0" Outlined="true">
                <MudStack Row="true" AlignItems="AlignItems.Start" Justify="Justify.SpaceBetween">
                    <div Style="flex: 1; overflow: hidden;">
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">Signed Response</MudText>
                        <MudText Typo="Typo.body2" Style="font-family: monospace; word-break: break-all; white-space: pre-wrap; font-size: 0.7rem; max-height: 120px; overflow-y: auto;">
                            @Model.SignedResponse
                        </MudText>
                    </div>
                    <MudTooltip Text="Copy to clipboard">
                        <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                       Color="Color.Secondary"
                                       OnClick="CopyResponseAsync" />
                    </MudTooltip>
                </MudStack>
            </MudPaper>

            <MudButton Color="Color.Default"
                       Variant="Variant.Text"
                       StartIcon="@Icons.Material.Filled.Refresh"
                       OnClick="@(() => Model.Reset.Execute())"
                       Class="mt-4">
                Accept Another Invite
            </MudButton>
        }
    </MudCardContent>
</MudCard>

@code {
    private bool _profileLoaded;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadProfileAsync();
    }

    private async Task LoadProfileAsync()
    {
        if (_profileLoaded)
        {
            return;
        }

        // Try to load profile silently (don't trigger auth if not already authenticated)
        if (!Model.PrfModel.HasKeys && !Model.PrfModel.RequiresOnDemandAuth)
        {
            return;
        }

        // For on-demand auth, wait until user authenticates (don't prefetch)
        if (Model.PrfModel.RequiresOnDemandAuth && !Model.PrfModel.HasKeys)
        {
            return;
        }

        var result = await UserProfileService.GetAsync();
        if (result is { Success: true, Value: not null })
        {
            // Check if profile has required fields
            if (string.IsNullOrWhiteSpace(result.Value.Username) ||
                string.IsNullOrWhiteSpace(result.Value.Email))
            {
                Snackbar.Add("Please configure your profile first.", Severity.Info);
                NavigationManager.NavigateTo("settings");
                return;
            }

            // Prefill the identity from profile
            Model.Username = result.Value.Username;
            Model.AccepterEmail = result.Value.Email;
            _profileLoaded = true;
            StateHasChanged();
        }
        else if (result.Success && result.Value is null)
        {
            // No profile exists - redirect to settings
            Snackbar.Add("Please configure your profile first.", Severity.Info);
            NavigationManager.NavigateTo("settings");
        }
    }

    private async Task CopyResponseAsync()
    {
        if (string.IsNullOrEmpty(Model.SignedResponse))
        {
            return;
        }

        try
        {
            await Clipboard.SetTextAsync(Model.SignedResponse);
            Snackbar.Add("Response copied!", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Failed to copy", Severity.Error);
        }
    }
}
